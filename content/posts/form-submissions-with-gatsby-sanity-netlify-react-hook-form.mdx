---
title: Form submission using Gatsby, SANITY, Netlify and React Hook Form
author: Eric Howey
authorLink: https://twitter.com/erchwy
categories: [Gatsby, SANITY.io, Netlify]
date: 2020-12-18
featuredImage: ../post-assets/featured-form-submissions.jpg
socialImage: ../post-assets/social-sanity-validation.jpg
draft: true
---

Buckle up. This is a big one.

We are going to walk through creating a contact form in [Gatsby](https://www.gatsbyjs.com/) that submits to an email address and also to a backend database using [SANITY.io](https://www.sanity.io/). The form itself will be built using [React Hook Form](https://react-hook-form.com/) and [Netlify forms](https://www.netlify.com/products/forms/). React Hook Form will manage form state for us, and Netlify forms provides easy access to a servless function and some basic SPAM prevention.

This post assumes you have some basic familiarity with Gatsby, Netlify and SANITY.io - and that you have installed CLI tools for all three technologies.

## Part 1: Getting setup

We are going to whip up an absolute barebones SANITY.io and Gatsby website using [Gatsby Theme Catalyst](https://www.gatsbycatalyst.com/). I use [Theme UI](https://theme-ui.com/) for all of my CSS but you could substitute whatever method you prefer for writing CSS. This will quickly gives us a barebones SANITY.io backend and Gatsby frontend to build off - it ain't pretty but it works! You can skip this part if it doesn't apply to you.

```shell
## install gatsby-starter-catalyst-sanity
gatsby new forms-demo https://github.com/ehowey/gatsby-starter-catalyst-sanity
```

Next we need to initialize a new SANITY dataset and backend.

```shell
## Navigate to the sanity-studio folder
cd sanity-studio
## Initialize a new SANITY.io dataset. Respond Y to reconfigure the studio. Use the default dataset configuration.
sanity init
```

Next we need to update the Sanity project id in `gatsby-config.js`. At the top of the `sanity.json` file you will see a value called `projectId`, it is usually a random string of letters and numbers. Copy and paste this value into the `sanityProjectId` option.

```js
{
      resolve: `gatsby-theme-catalyst-sanity`,
      options: {
        // Example for an env variable
        // sanityProjectId: process.env.SANITY_PROJECT_ID,
        // sanityDataset: process.env.SANITY_DATASET,
        // sanityToken: process.env.SANITY_TOKEN,
        //
        // Default options are:
        // sanityProjectId: "abc123" // Required
        // sanityDataset: "production"
        // sanityToken: null
        // sanityWatchMode: true
        // sanityOverlayDrafts: false // Token is required for this
        // sanityCreatePages: true
        // sanityCreatePosts: true
        // sanityCreatePostsList: true
        // sanityCreateProjects: true
        // sanityCreateProjectsList: true
        // sanityPostPath: "/posts"
        // sanityProjectPath: "/projects"
        // useSanityTheme: false // Experimental right now
        sanityProjectId: "abcd1234",
      },
    },
```

Next we need to create a basic contact schema for SANITY.io that we will use to hold our form submissions. Create the following file, `sanity-studio/schemas/contact.js`.

```js
export default {
  name: "contact",
  title: "Contact submissions",
  type: "document",
  fields: [
    {
      name: "name",
      title: "Name",
      type: "string",
    },
    {
      name: "email",
      title: "Email",
      type: "string",
    },
    {
      name: "message",
      title: "Message",
      type: "text",
    },
  ],
}
```

You will need to import and export this file within `sanity-studio/schemas/schema.js`.

```js
//...other imports above
import contact from "./contact"

// Then we give our schema to the builder and provide the result to Sanity
export default createSchema({
  // We name our schema
  name: "default",
  // Then proceed to concatenate our document type
  // to the ones provided by any plugins that are installed
  types: schemaTypes.concat([
    // The following are document types which will appear
    // in the studio.
    // ... other exports above
    contact,
  ]),
})
```

Last we need to deploy a GraphQL API from SANITY.io. Inside of the `sanity-studio` folder run the following command:

```
sanity graphql deploy
```

If you wanted to you could add some pages or other data to SANITY.io but for now we are finished with SANITY.io. Let's head back to Gatsby land.

Create an index page for the project at `src/pages/index.js` that looks something like this. You can copy and past this and create a `success.js` page as well where we will redirect to when a submission is successful.

```js
import React from "react"

const Home = () => {
  return (
    <div>
      <h1>Hello World</h1>
    </div>
  )
}

export default Home
```

Run `gatsby develop` for the first time and marvel at your beautiful Hello World!

At this point you should also initialize a new GitHub repo for the demo and make an initial commit to the repository. This will be needed in future steps with deployment to Netlify.

## Part 2: Creating our form

We will use React Hook Form to create our form. You will need to install it as a dependency in your project. I enjoy React Hook Form beacuse it has great documentation and an intuitive API. You can follow their docs to expand on the simple example in this post.

```shell
## install react hook form
yarn add react-hook-form
```

Here is a basic contact form in the `index.js` file replacing the Hello World from before.

```js
import React from "react"
import { useForm } from "react-hook-form"

const Home = () => {
  // Initiate forms
  const { register, handleSubmit, errors, reset } = useForm()

  const handlePost = (formData) => {
    console.log(formData)
  }

  return (
    <form
      onSubmit={handleSubmit(handlePost)}
      name="request-changes"
      method="POST"
      action="/success/"
      data-netlify="true"
      netlify-honeypot="got-ya"
    >
      <input type="hidden" name="form-name" value="request-changes" />
      <input
        type="hidden"
        name="formId"
        value="request-changes"
        ref={register()}
      />
      <label htmlFor="name">
        <p>Name</p>
        {errors.name && <span>Error message</span>}
        <input name="name" ref={register({ required: true })} />
      </label>
      <label htmlFor="email">
        <p>Email</p>
        {errors.email && <span>Please format email correctly</span>}
        <input
          name="email"
          ref={register({
            required: true,
            pattern: /[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?/,
          })}
        />
      </label>
      <label htmlFor="message">
        <p>Message</p>
        <textarea rows="4" name="message" ref={register()} />
      </label>
      <label
        htmlFor="got-ya"
        style={{
          position: "absolute",
          overflow: "hidden",
          clip: "rect(0 0 0 0)",
          height: "1px",
          width: "1px",
          margin: "-1px",
          padding: "0",
          border: "0",
        }}
      >
        Donâ€™t fill this out if you're human:
        <input tabIndex="-1" name="got-ya" ref={register()} />
      </label>
      <div>
        <button type="submit">Submit</button>
      </div>
    </form>
  )
}

export default Home
```

There is lots happening here so let's break it down into chunks.

To begin with you import the `useForm` hook and then use this hook to access the forms APIs. In this example we are using `handleSubmit`, `errors`, `register` and `reset`. Handle submit is a callback function that gets executed once the form is submitted. Errors provides form validation based on the input name, and specified regex patterns. In this example the name field is required, the email field is also required, but has a regex pattern to match a valid email address as well. The message field is optional. Register is a required function that handles input state and value and is called using the ref prop on each input. Reset is not in use now, but we will call it later after the form submission.

Next there is a `handlePost` function which right now is just console logging our submitted form data, but later will be used to submit to Netlify and ultimately SANITY via a serverless function.

Now we have the form itself. There are few important things happening just in the opening form tag that are worth noting. The form `handleSubmit` function gets called on form submission which allows React Hook Form to handle the form validation before submission. The form is given a name, and a POST method is specified. Finally there are two special Netlify attributes, `data-netlify="true"` and `netlify-honeypot="got-ya"` which enable Netlify forms, and a honeypot field for some basic spam prevention.

After the opening form tag are two hidden fields. The first hidden field is required by Netlify and the second hidden field gives us some extra power once inside the serverless function to conditionally handle logic for different forms.

Last, but not least are the different form inputs including a visually hidden honeypot input. Notice that each input has a `ref={register()}` attribute on it. The name and email field include additional options for form validation.

Check your console and make sure your are seeing the form submission values logged there correctly.

## Part 3: Sending it to Netlify

Now that we have a working form, we need to do something more than console.log the results. We are going to update our `handlePost` function to manage submitting the form to the Netlify.

You are going to need the site deployed on Netlify from this point forward. The easiest way to do this is by running the [Netlify CLI](https://github.com/netlify/cli) command `netlify init`. Your repository needs to be on GitHub already for this step to work.

Once your site is setup with Netlify you can run the command `netlify dev` to run the Netlify development environment locally on your computer, this will be critical for testing out our Netlify function.

Here is our new `handlePost` function and a companion encoding function that puts the form data into the correct format for Netlify to handle on their end. We use the `navigate` function from Gatsby to redirect after a successful form submission so you will need to import this at the top of your file, `import { navigate } from "gatsby"`.

```js
// Transforms the form data from the React Hook Form output to a format Netlify can read
const encode = (data) => {
  return Object.keys(data)
    .map((key) => encodeURIComponent(key) + "=" + encodeURIComponent(data[key]))
    .join("&")
}

// Handles the post process to Netlify so we can access their serverless functions
const handlePost = (formData, event) => {
  fetch(`/`, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: encode({ "form-name": "contact-form", ...formData }),
  })
    .then((response) => {
      navigate("/success/")
      reset()
      console.log(response)
    })
    .catch((error) => {
      console.log(error)
    })
  event.preventDefault()
}
```

## Part 4: Sending it to SANITY

-serverless function
